const chai = require('chai');
const chaiAsPromised = require('chai-as-promised');
chai.use(chaiAsPromised)
const expect = chai.expect;
const nock = require('nock');
const { HackerNewsScraper } = require('./index.js');

const scraper =  new HackerNewsScraper();

describe('Initialization test', () => {
  it('should set the URL correctly during initialization', () => {
    expect(scraper.URL).to.eql('https://news.ycombinator.com');
  });
});

describe('Test for valid parameters in getTopPosts', () => {
  it('should throw an error when calling the function without any parameters', async () => {
    await expect(scraper.getTopPosts()).to.be.rejectedWith('Number of posts should be a positive integer <= 100');
  });

  it('should throw an error when calling the function with a number > 100', async () => {
    await expect(scraper.getTopPosts(101)).to.be.rejectedWith('Number of posts should be a positive integer <= 100');
  });

  it('should throw an error when calling the function with a 0', async () => {
    await expect(scraper.getTopPosts(0)).to.be.rejectedWith('Number of posts should be a positive integer <= 100'); 
  });

  it('should throw an error when calling the function with a negative number', async () => {
    await expect(scraper.getTopPosts(-1)).to.be.rejectedWith('Number of posts should be a positive integer <= 100'); 
  });

  it('should throw an error when calling the function with a floating number', async () => {
    await expect(scraper.getTopPosts(10.6)).to.be.rejectedWith('Number of posts should be a positive integer <= 100'); 
  });

  it('should throw an error when calling the function with a invalid number', async () => {
    await expect(scraper.getTopPosts('56f')).to.be.rejectedWith('Number of posts should be a positive integer <= 100'); 
  });
});

describe('Test for API call', () => {
  it('should pass the error correctly when there is an error from server side', async () => {
    nock(scraper.URL)
      .get('/news?p=1')
      .reply(500, null);
    await expect(scraper.getTopPosts(1)).to.be.rejectedWith(`Error: Request failed with status code 500 while hitting URL: ${scraper.URL}`);
  });

  it('should pass the error correctly when there is a 404 error', async () => {
    nock(scraper.URL)
      .get('/news?p=1')
      .reply(404, null);
    await expect(scraper.getTopPosts(1)).to.be.rejectedWith(`Error: Request failed with status code 404 while hitting URL: ${scraper.URL}`);
  });
});

describe('Test for posts validity', () => {
  beforeEach(() => {
    const dummyResponse1 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">1.</span></td> <td class="title"><a href="https://www.bbc.co.uk/news/post-1" class="storylink">Post-1</a></td> </tr> <tr> <td class="subtext"> <span class="score">10 points</span> by <a href="user?id=hanoz" class="hnuser">Author-1</a> <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">5 comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';
    const dummyResponse3 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">3.</span></td> <td class="title"><a href="https://www.bbc.co.uk/news/post-3" class="storylink">Post-3</a></td> </tr> <tr> <td class="subtext"> <span class="score">30 points</span> by <a href="user?id=hanoz" class="hnuser">Author-3</a> <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">15 comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';

    nock(scraper.URL)
      .get('/')
      .reply(200, dummyResponse1);
    nock(scraper.URL)
      .get('/news?p=1')
      .reply(200, dummyResponse1);
    nock(scraper.URL)
      .get('/news?p=3')
      .reply(200, dummyResponse3);
  });

  it('should get the top two posts corectly', async () => {
    const dummyResponse2 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">2.</span></td> <td class="title"><a href="https://www.bbc.co.uk/news/post-2" class="storylink">Post-2</a></td> </tr> <tr> <td class="subtext"> <span class="score">20 points</span> by <a href="user?id=hanoz" class="hnuser">Author-2</a> <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">10 comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';
    nock(scraper.URL)
      .get('/news?p=2')
      .reply(200, dummyResponse2);

    let posts = await scraper.getTopPosts(2);
    expect(posts).to.eql([
      {
        title: 'Post-1',
        uri: 'https://www.bbc.co.uk/news/post-1',
        author: 'Author-1',
        rank: 1,
        points: 10,
        comments: 5
      },
      {
        title: 'Post-2',
        uri: 'https://www.bbc.co.uk/news/post-2',
        author: 'Author-2',
        rank: 2,
        points: 20,
        comments: 10
      }
    ]);
  });

  it('should ignore any post with empty title', async () => {
    let dummyResponse2 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">2.</span></td> <td class="title"><a href="https://www.bbc.co.uk/news/post-2" class="storylink"></a></td> </tr> <tr> <td class="subtext"> <span class="score">20 points</span> by <a href="user?id=hanoz" class="hnuser">Author-2</a> <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">10 comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';
    nock(scraper.URL)
      .get('/news?p=2')
      .reply(200, dummyResponse2);

    let posts = await scraper.getTopPosts(2);
    expect(posts).to.eql([
      {
        title: 'Post-1',
        uri: 'https://www.bbc.co.uk/news/post-1',
        author: 'Author-1',
        rank: 1,
        points: 10,
        comments: 5
      },
      {
        title: 'Post-3',
        uri: 'https://www.bbc.co.uk/news/post-3',
        author: 'Author-3',
        rank: 3,
        points: 30,
        comments: 15
      }
    ]);
  });

  it('should ignore any post with no author', async () => {
    const dummyResponse2 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">2.</span></td> <td class="title"><a href="https://www.bbc.co.uk/news/post-2" class="storylink">Post-2</a></td> </tr> <tr> <td class="subtext"> <span class="score">20 points</span> by <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">10 comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';
    nock(scraper.URL)
      .get('/news?p=2')
      .reply(200, dummyResponse2);

    let posts = await scraper.getTopPosts(2);
    expect(posts).to.eql([
      {
        title: 'Post-1',
        uri: 'https://www.bbc.co.uk/news/post-1',
        author: 'Author-1',
        rank: 1,
        points: 10,
        comments: 5
      },
      {
        title: 'Post-3',
        uri: 'https://www.bbc.co.uk/news/post-3',
        author: 'Author-3',
        rank: 3,
        points: 30,
        comments: 15
      }
    ]);
  });

  it('should ignore any post with invalid uri', async () => {
    const dummyResponse2 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">2.</span></td> <td class="title"><a href="Looks like an url" class="storylink">Post-2</a></td> </tr> <tr> <td class="subtext"> <span class="score">20 points</span> by <a href="user?id=hanoz" class="hnuser">Author-2</a> <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">10 comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';
    nock(scraper.URL)
      .get('/news?p=2')
      .reply(200, dummyResponse2);

    let posts = await scraper.getTopPosts(2);
    expect(posts).to.eql([
      {
        title: 'Post-1',
        uri: 'https://www.bbc.co.uk/news/post-1',
        author: 'Author-1',
        rank: 1,
        points: 10,
        comments: 5
      },
      {
        title: 'Post-3',
        uri: 'https://www.bbc.co.uk/news/post-3',
        author: 'Author-3',
        rank: 3,
        points: 30,
        comments: 15
      }
    ]);
  });

  it('should ignore any post with floating points', async () => {
    const dummyResponse2 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">2.</span></td> <td class="title"><a href="https://www.bbc.co.uk/news/post-2" class="storylink">Post-2</a></td> </tr> <tr> <td class="subtext"> <span class="score">20.7 points</span> by <a href="user?id=hanoz" class="hnuser">Author-2</a> <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">10 comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';
    nock(scraper.URL)
      .get('/news?p=2')
      .reply(200, dummyResponse2);

    let posts = await scraper.getTopPosts(2);
    expect(posts).to.eql([
      {
        title: 'Post-1',
        uri: 'https://www.bbc.co.uk/news/post-1',
        author: 'Author-1',
        rank: 1,
        points: 10,
        comments: 5
      },
      {
        title: 'Post-3',
        uri: 'https://www.bbc.co.uk/news/post-3',
        author: 'Author-3',
        rank: 3,
        points: 30,
        comments: 15
      }
    ]);
  });

  it('should ignore any post with negative rank', async () => {
    const dummyResponse2 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">-2.</span></td> <td class="title"><a href="https://www.bbc.co.uk/news/post-2" class="storylink">Post-2</a></td> </tr> <tr> <td class="subtext"> <span class="score">20 points</span> by <a href="user?id=hanoz" class="hnuser">Author-2</a> <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">10 comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';
    nock(scraper.URL)
      .get('/news?p=2')
      .reply(200, dummyResponse2);

    let posts = await scraper.getTopPosts(2);
    expect(posts).to.eql([
      {
        title: 'Post-1',
        uri: 'https://www.bbc.co.uk/news/post-1',
        author: 'Author-1',
        rank: 1,
        points: 10,
        comments: 5
      },
      {
        title: 'Post-3',
        uri: 'https://www.bbc.co.uk/news/post-3',
        author: 'Author-3',
        rank: 3,
        points: 30,
        comments: 15
      }
    ]);
  });

  it('should ignore any post with invalid integer comment', async () => {
    const dummyResponse2 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">2.</span></td> <td class="title"><a href="https://www.bbc.co.uk/news/post-2" class="storylink">Post-2</a></td> </tr> <tr> <td class="subtext"> <span class="score">20 points</span> by <a href="user?id=hanoz" class="hnuser">Author-2</a> <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">10c comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';
    nock(scraper.URL)
      .get('/news?p=2')
      .reply(200, dummyResponse2);

    let posts = await scraper.getTopPosts(2);
    expect(posts).to.eql([
      {
        title: 'Post-1',
        uri: 'https://www.bbc.co.uk/news/post-1',
        author: 'Author-1',
        rank: 1,
        points: 10,
        comments: 5
      },
      {
        title: 'Post-3',
        uri: 'https://www.bbc.co.uk/news/post-3',
        author: 'Author-3',
        rank: 3,
        points: 30,
        comments: 15
      }
    ]);
  });

  it('should throw an error if number of valid posts in not enough', async () => {
    const dummyResponse2 = '<html> <body> <table id="hnmain"> <tbody> <tr class="athing"> <td class="title"><span class="rank">2.</span></td> <td class="title"><a href="https://www.bbc.co.uk/news/post-2" class="storylink">Post-2</a></td> </tr> <tr> <td class="subtext"> <span class="score">20 points</span> by <a href="user?id=hanoz" class="hnuser">Author-2</a> <span class="age"><a href="item?id=20439425">27 minutes ago</a></span> <span id="unv_20439425"></span> | <a href="hide?id=20439425&goto=news">hide</a> | <a href="item?id=20439425">10c comment</a> </td> </tr> <tr class="spacer" style="height:5px"></tr> </tbody> </table> </body> </html>';
    const dummyResponse4 = '<html></html>'
    nock(scraper.URL)
      .get('/news?p=2')
      .reply(200, dummyResponse2);
    nock(scraper.URL)
      .get('/news?p=4')
      .reply(200, dummyResponse4);

    await expect(scraper.getTopPosts(3)).to.be.rejectedWith('Not enough valid posts.');
  });
});
